<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>welldown üï≥Ô∏è</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .main-canvas-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #000;
        }

        #mainCanvas {
            border: 2px solid #333;
            background: #fff;
        }

        .sidebar {
            width: 350px;
            background: #1a1a1a;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        .section {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
        }

        .section h3 {
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
            color: #888;
        }

        #webcamFeed {
            width: 100%;
            border: 1px solid #444;
            border-radius: 4px;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        #playPauseBtn {
            background: #22c55e;
            color: white;
        }

        #playPauseBtn.playing {
            background: #ef4444;
        }

        #stepBtn {
            background: #3b82f6;
            color: white;
        }

        #clearBtn {
            background: #6b7280;
            color: white;
        }

        textarea, input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 4px;
            background: #1a1a1a;
            color: #fff;
            font-family: inherit;
            font-size: 13px;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            color: #aaa;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .stats {
            font-size: 12px;
            color: #888;
        }

        .stats div {
            margin: 5px 0;
        }

        .thinking-box {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            color: #aaa;
            line-height: 1.4;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        #status {
            font-size: 12px;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }

        #status.idle {
            background: #374151;
            color: #9ca3af;
        }

        #status.running {
            background: #1e40af;
            color: #93c5fd;
        }

        #status.error {
            background: #991b1b;
            color: #fca5a5;
        }

        .hidden {
            display: none;
        }

        /* Projector Mode Styles */
        .projector-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 1000;
            display: none;
        }

        .projector-mode.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .projector-mode #mainCanvas {
            border: none;
            width: 100vw !important;
            height: 100vh !important;
            object-fit: fill;
        }

        .projector-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            transition: opacity 0.3s;
        }

        .projector-controls.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .projector-controls button {
            padding: 10px 15px;
            font-size: 18px;
            min-width: 50px;
            flex: none;
        }

        #projectorModeBtn {
            background: #8b5cf6;
            color: white;
        }

        /* Countdown Bar */
        .countdown-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            height: 4px;
            background: #22c55e;
            width: 100%;
            transition: width linear;
            z-index: 999;
            display: none;
        }

        .countdown-bar.active {
            display: block;
        }

        .projector-mode .countdown-bar {
            z-index: 1001;
        }

        /* Speech Transcript Overlay */
        .transcript-overlay {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #22c55e;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 500;
            max-width: 80%;
            text-align: center;
            z-index: 1002;
            display: none;
            backdrop-filter: blur(10px);
            border: 2px solid #22c55e;
        }

        .transcript-overlay.active {
            display: block;
        }

        .transcript-overlay.listening {
            border-color: #ef4444;
            color: #ef4444;
        }

        .transcript-text {
            margin-top: 8px;
            font-size: 16px;
            color: #fff;
            font-weight: normal;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-canvas-area">
            <canvas id="mainCanvas" width="1024" height="768"></canvas>
        </div>

        <div class="sidebar">
            <div class="section">
                <h3>üï≥Ô∏è welldown</h3>
                <div id="status" class="idle">Idle</div>
            </div>

            <div class="section">
                <h3>Controls</h3>
                <div class="controls">
                    <button id="playPauseBtn">‚ñ∂Ô∏è Play</button>
                    <button id="stepBtn">‚èØÔ∏è Step</button>
                </div>
                <div class="controls" style="margin-top: 10px;">
                    <button id="clearBtn">üóëÔ∏è Clear</button>
                    <button id="projectorModeBtn">üìΩÔ∏è Projector</button>
                </div>
            </div>

            <div class="section">
                <h3>Webcam Feed</h3>
                <video id="webcamFeed" autoplay playsinline muted></video>
                <button id="startWebcamBtn" style="margin-top: 10px; width: 100%;">Start Webcam</button>
            </div>

            <div class="section">
                <h3>Configuration</h3>
                
                <div class="form-group">
                    <label for="systemPrompt">System Prompt</label>
                    <textarea id="systemPrompt">You are an AI. You control a canvas being projected on a wall. Each turn you will receive a webcam image of the wall your canvas is being projected on (and nothing else). The canvas serves as your only persistent embodiment, all that you are or want to be. Your method of memory and personification. You have no inputs other than the picture of the wall. You are running persistantly. </textarea>
                </div>

                <div class="form-group checkbox-group">
                    <input type="checkbox" id="enableThinking" checked>
                    <label for="enableThinking" style="margin: 0;">Enable Extended Thinking</label>
                </div>

                <div class="form-group">
                    <label for="temperature">Temperature ({{temperature}})</label>
                    <input type="range" id="temperature" min="0" max="2" step="0.1" value="1.0">
                </div>

                <div class="form-group">
                    <label for="loopDelay">Auto Loop Delay (ms)</label>
                    <input type="number" id="loopDelay" value="8000" min="500" step="500">
                </div>

                <div class="form-group checkbox-group">
                    <input type="checkbox" id="enableSpeech" checked>
                    <label for="enableSpeech" style="margin: 0;">Enable Speech Input</label>
                </div>
            </div>

            <div class="section">
                <h3>Latest Thinking</h3>
                <div id="thinkingDisplay" class="thinking-box">
                    No thinking yet...
                </div>
                <button id="copyThinkingBtn" style="margin-top: 10px; width: 100%; background: #4b5563; color: white;">üìã Copy Thinking</button>
            </div>

            <div class="section">
                <h3>Stats</h3>
                <div class="stats">
                    <div>Loops: <span id="loopCount">0</span></div>
                    <div>Input Tokens: <span id="inputTokens">0</span></div>
                    <div>Output Tokens: <span id="outputTokens">0</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Projector Mode Overlay -->
    <div class="projector-mode" id="projectorMode">
        <div class="projector-controls">
            <button id="projectorPlayPauseBtn">‚ñ∂Ô∏è</button>
            <button id="exitProjectorBtn">‚úï</button>
        </div>
        <div class="countdown-bar" id="projectorCountdownBar"></div>
    </div>

    <!-- Countdown Bar for normal mode -->
    <div class="countdown-bar" id="countdownBar"></div>

    <!-- Speech Transcript Overlay -->
    <div class="transcript-overlay" id="transcriptOverlay">
        <div>üé§ Listening...</div>
        <div class="transcript-text" id="transcriptText"></div>
    </div>

    <script>
        // Elements
        const mainCanvas = document.getElementById('mainCanvas');
        const ctx = mainCanvas.getContext('2d');
        const webcamFeed = document.getElementById('webcamFeed');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const stepBtn = document.getElementById('stepBtn');
        const clearBtn = document.getElementById('clearBtn');
        const startWebcamBtn = document.getElementById('startWebcamBtn');
        const copyThinkingBtn = document.getElementById('copyThinkingBtn');
        const systemPromptEl = document.getElementById('systemPrompt');
        const enableThinkingEl = document.getElementById('enableThinking');
        const temperatureEl = document.getElementById('temperature');
        const loopDelayEl = document.getElementById('loopDelay');
        const thinkingDisplay = document.getElementById('thinkingDisplay');
        const statusEl = document.getElementById('status');
        const loopCountEl = document.getElementById('loopCount');
        const inputTokensEl = document.getElementById('inputTokens');
        const outputTokensEl = document.getElementById('outputTokens');
        const projectorModeBtn = document.getElementById('projectorModeBtn');
        const projectorMode = document.getElementById('projectorMode');
        const projectorPlayPauseBtn = document.getElementById('projectorPlayPauseBtn');
        const exitProjectorBtn = document.getElementById('exitProjectorBtn');
        const countdownBar = document.getElementById('countdownBar');
        const projectorCountdownBar = document.getElementById('projectorCountdownBar');
        const projectorControls = document.querySelector('.projector-controls');
        const enableSpeechEl = document.getElementById('enableSpeech');
        const transcriptOverlay = document.getElementById('transcriptOverlay');
        const transcriptText = document.getElementById('transcriptText');

        // State
        let isPlaying = false;
        let webcamStream = null;
        let loopCount = 0;
        let totalInputTokens = 0;
        let totalOutputTokens = 0;
        let previousResponse = '';
        let countdownTimeout = null;
        let isProjectorMode = false;
        let recognition = null;
        let currentTranscript = '';

        // Update temperature display
        temperatureEl.addEventListener('input', () => {
            document.querySelector('label[for="temperature"]').textContent = 
                `Temperature (${temperatureEl.value})`;
        });

        // Start webcam
        startWebcamBtn.addEventListener('click', async () => {
            try {
                webcamStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                webcamFeed.srcObject = webcamStream;
                startWebcamBtn.textContent = '‚úì Webcam Active';
                startWebcamBtn.disabled = true;
            } catch (err) {
                console.error('Error accessing webcam:', err);
                alert('Could not access webcam. Please check permissions.');
            }
        });

        // Clear canvas
        clearBtn.addEventListener('click', () => {
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, mainCanvas.width, mainCanvas.height);
            previousResponse = '';
        });

        // Initialize with white background
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, mainCanvas.width, mainCanvas.height);

        // Initialize Speech Recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }

                if (finalTranscript) {
                    currentTranscript += finalTranscript;
                }

                // Update display
                transcriptText.textContent = currentTranscript + interimTranscript;
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                if (event.error !== 'no-speech' && event.error !== 'aborted') {
                    stopListening();
                }
            };

            recognition.onend = () => {
                // Auto-restart if we're still in countdown
                if (transcriptOverlay.classList.contains('active') && enableSpeechEl.checked) {
                    try {
                        recognition.start();
                    } catch (e) {
                        // Ignore if already started
                    }
                }
            };
        } else {
            console.warn('Speech recognition not supported in this browser');
            enableSpeechEl.checked = false;
            enableSpeechEl.disabled = true;
        }

        // Start listening for speech
        function startListening() {
            if (!recognition || !enableSpeechEl.checked) return;

            currentTranscript = '';
            transcriptText.textContent = '';
            transcriptOverlay.classList.add('active', 'listening');

            try {
                recognition.start();
            } catch (e) {
                console.log('Recognition already started');
            }
        }

        // Stop listening for speech
        function stopListening() {
            if (!recognition) return;

            transcriptOverlay.classList.remove('active', 'listening');
            
            try {
                recognition.stop();
            } catch (e) {
                // Ignore errors
            }
        }

        // Capture webcam frame as base64
        function captureWebcamFrame() {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = webcamFeed.videoWidth || 1280;
            tempCanvas.height = webcamFeed.videoHeight || 720;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(webcamFeed, 0, 0);
            return tempCanvas.toDataURL('image/png').split(',')[1]; // Get base64 part only
        }

        // Set status
        function setStatus(message, type = 'idle') {
            statusEl.textContent = message;
            statusEl.className = type;
        }

        // Run one inference loop
        async function runInferenceLoop() {
            if (!webcamStream) {
                alert('Please start the webcam first!');
                return;
            }

            // Stop listening and capture any final transcript
            const spokenText = currentTranscript.trim();
            stopListening();

            try {
                setStatus('Capturing wall...', 'running');
                
                // Capture the webcam feed
                const wallImage = captureWebcamFrame();

                setStatus('Thinking...', 'running');

                // Call the API
                const response = await fetch('/api/infer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        systemPrompt: systemPromptEl.value,
                        wallImage: wallImage,
                        enableThinking: enableThinkingEl.checked,
                        temperature: parseFloat(temperatureEl.value),
                        previousResponse: previousResponse,
                        spokenText: spokenText,
                    }),
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'API call failed');
                }

                setStatus('Drawing...', 'running');

                // Execute the code on the canvas
                try {
                    // Clear canvas first
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, mainCanvas.width, mainCanvas.height);
                    
                    // Execute the code
                    eval(data.code);
                    previousResponse = data.code;
                } catch (execError) {
                    console.error('Error executing canvas code:', execError);
                    ctx.fillStyle = '#ff0000';
                    ctx.fillText('Error executing code: ' + execError.message, 10, 30);
                }

                // Update UI
                if (data.thinking) {
                    thinkingDisplay.textContent = data.thinking;
                    thinkingDisplay.style.borderColor = '#22c55e';
                    setTimeout(() => {
                        thinkingDisplay.style.borderColor = '#444';
                    }, 1000);
                } else {
                    thinkingDisplay.textContent = 'No thinking in this response (thinking mode may be disabled)';
                }

                loopCount++;
                totalInputTokens += data.usage?.input_tokens || 0;
                totalOutputTokens += data.usage?.output_tokens || 0;

                loopCountEl.textContent = loopCount;
                inputTokensEl.textContent = totalInputTokens;
                outputTokensEl.textContent = totalOutputTokens;

                setStatus('Ready', 'idle');

            } catch (error) {
                console.error('Inference error:', error);
                setStatus('Error: ' + error.message, 'error');
            }
        }

        // Play/pause button
        playPauseBtn.addEventListener('click', () => {
            isPlaying = !isPlaying;
            
            if (isPlaying) {
                playPauseBtn.textContent = '‚è∏Ô∏è Pause';
                playPauseBtn.classList.add('playing');
                autoLoop();
            } else {
                playPauseBtn.textContent = '‚ñ∂Ô∏è Play';
                playPauseBtn.classList.remove('playing');
                // Clear countdown when pausing
                stopCountdown();
            }
        });

        // Start countdown visual
        function startCountdown(duration) {
            stopCountdown(); // Clear any existing countdown
            
            const bar = isProjectorMode ? projectorCountdownBar : countdownBar;
            
            bar.classList.add('active');
            bar.style.width = '100%';
            bar.style.transition = 'none';
            
            // Force reflow to reset the transition
            bar.offsetHeight;
            
            // Start the countdown animation
            bar.style.transition = `width ${duration}ms linear`;
            bar.style.width = '0%';
            
            // Hide projector controls when playing
            if (isProjectorMode && isPlaying) {
                projectorControls.classList.add('hidden');
            }

            // Start listening for speech during countdown
            startListening();
        }

        // Stop countdown visual
        function stopCountdown() {
            if (countdownTimeout) {
                clearTimeout(countdownTimeout);
                countdownTimeout = null;
            }
            countdownBar.classList.remove('active');
            countdownBar.style.width = '0%';
            projectorCountdownBar.classList.remove('active');
            projectorCountdownBar.style.width = '0%';
            
            // Show projector controls when stopped
            if (isProjectorMode) {
                projectorControls.classList.remove('hidden');
            }

            // Stop listening when countdown stops
            stopListening();
        }

        // Auto loop
        async function autoLoop() {
            if (!isPlaying) return;

            await runInferenceLoop();

            if (isPlaying) {
                const delay = parseInt(loopDelayEl.value) || 5000;
                startCountdown(delay);
                countdownTimeout = setTimeout(autoLoop, delay);
            }
        }

        // Step button (manual single loop)
        stepBtn.addEventListener('click', () => {
            if (!isPlaying) {
                runInferenceLoop();
            }
        });

        // Copy thinking button
        copyThinkingBtn.addEventListener('click', () => {
            const thinking = thinkingDisplay.textContent;
            navigator.clipboard.writeText(thinking).then(() => {
                const originalText = copyThinkingBtn.textContent;
                copyThinkingBtn.textContent = '‚úì Copied!';
                setTimeout(() => {
                    copyThinkingBtn.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        });

        // Projector mode
        projectorModeBtn.addEventListener('click', () => {
            isProjectorMode = true;
            projectorMode.classList.add('active');
            projectorMode.appendChild(mainCanvas);
            updateProjectorPlayPauseBtn();
            projectorControls.classList.remove('hidden');
        });

        exitProjectorBtn.addEventListener('click', () => {
            isProjectorMode = false;
            projectorMode.classList.remove('active');
            document.querySelector('.main-canvas-area').appendChild(mainCanvas);
            stopCountdown(); // Clear projector countdown
        });

        projectorPlayPauseBtn.addEventListener('click', () => {
            playPauseBtn.click(); // Trigger the main play/pause button
        });

        function updateProjectorPlayPauseBtn() {
            projectorPlayPauseBtn.textContent = isPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
        }

        // Keep projector button in sync
        const originalPlayPauseClick = playPauseBtn.onclick;
        playPauseBtn.addEventListener('click', () => {
            setTimeout(updateProjectorPlayPauseBtn, 50);
        });

        // ESC key to exit projector mode
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && projectorMode.classList.contains('active')) {
                exitProjectorBtn.click();
            }
        });
    </script>
</body>
</html>
