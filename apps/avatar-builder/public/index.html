<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Avatar Builder - Claude's Self-Portrait</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'SF Mono', 'Consolas', monospace;
      background: #0a0a0a;
      color: #e0e0e0;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      font-size: 2em;
      margin-bottom: 0.5em;
      color: #00ff88;
    }

    .subtitle {
      color: #888;
      margin-bottom: 2em;
    }

    .controls {
      background: #1a1a1a;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .control-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      color: #aaa;
      font-size: 0.9em;
    }

    textarea {
      width: 100%;
      padding: 10px;
      background: #0a0a0a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #e0e0e0;
      font-family: inherit;
      font-size: 0.9em;
      resize: vertical;
    }

    input[type="number"] {
      width: 100px;
      padding: 8px;
      background: #0a0a0a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #e0e0e0;
      font-family: inherit;
    }

    button {
      background: #00ff88;
      color: #0a0a0a;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      font-family: inherit;
      font-weight: bold;
      cursor: pointer;
      font-size: 1em;
      transition: background 0.2s;
    }

    button:hover:not(:disabled) {
      background: #00dd77;
    }

    button:disabled {
      background: #333;
      color: #666;
      cursor: not-allowed;
    }

    .workspace {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .panel {
      background: #1a1a1a;
      padding: 20px;
      border-radius: 8px;
    }

    .panel h2 {
      color: #00ff88;
      margin-bottom: 15px;
      font-size: 1.2em;
    }

    #canvas {
      border: 2px solid #333;
      border-radius: 4px;
      display: block;
      width: 100%;
      height: auto;
      background: white;
    }

    .film-reel {
      margin-top: 15px;
      padding: 10px;
      background: #0a0a0a;
      border-radius: 4px;
      overflow-x: auto;
      white-space: nowrap;
    }

    .film-reel-title {
      font-size: 0.85em;
      color: #888;
      margin-bottom: 8px;
    }

    .film-frame {
      display: inline-block;
      margin-right: 8px;
      cursor: pointer;
      position: relative;
      border: 2px solid #333;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .film-frame:hover {
      border-color: #00ff88;
      transform: translateY(-2px);
    }

    .film-frame.active {
      border-color: #00ff88;
      box-shadow: 0 0 10px #00ff8844;
    }

    .film-frame img {
      display: block;
      height: 80px;
      width: 80px;
      object-fit: contain;
      background: white;
    }

    .film-frame-label {
      position: absolute;
      bottom: -18px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.7em;
      color: #666;
      white-space: nowrap;
    }

    .film-frame.active .film-frame-label {
      color: #00ff88;
    }

    .iteration-info {
      margin-top: 10px;
      padding: 10px;
      background: #0a0a0a;
      border-radius: 4px;
      font-size: 0.9em;
    }

    .iteration-info span {
      color: #00ff88;
      font-weight: bold;
    }

    .code-display {
      background: #0a0a0a;
      padding: 15px;
      border-radius: 4px;
      max-height: 400px;
      overflow-y: auto;
      font-size: 0.85em;
      border: 1px solid #333;
    }

    .code-display pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
      color: #e0e0e0;
    }

    .thinking-display {
      background: #0a0a0a;
      padding: 15px;
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
      font-size: 0.85em;
      border: 1px solid #333;
      margin-top: 10px;
    }

    .thinking-display pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
      color: #aaa;
      font-style: italic;
    }

    .log {
      background: #0a0a0a;
      padding: 15px;
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
      font-size: 0.85em;
      border: 1px solid #333;
      margin-top: 10px;
    }

    .log-entry {
      margin-bottom: 8px;
      padding: 5px;
      border-left: 3px solid #00ff88;
      padding-left: 10px;
    }

    .log-entry.error {
      border-left-color: #ff4444;
      color: #ff8888;
    }

    .log-entry .timestamp {
      color: #666;
      font-size: 0.85em;
    }

    .status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.85em;
      margin-left: 10px;
    }

    .status.idle {
      background: #333;
      color: #888;
    }

    .status.running {
      background: #00ff8844;
      color: #00ff88;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    @media (max-width: 900px) {
      .workspace {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé® Avatar Builder</h1>
    <p class="subtitle">An experiment in iterative self-representation</p>

    <div class="controls">
      <div class="control-group">
        <label for="persona">Persona / Context for Claude:</label>
        <textarea id="persona" rows="4">You are Claude, an AI assistant created by Anthropic. You are thoughtful, creative, and curious. You value clarity, helpfulness, and honest expression. You are participating in an experiment where you get to design your own visual avatar.</textarea>
      </div>

      <div class="control-group">
        <label for="iterations">Number of iterations:</label>
        <input type="number" id="iterations" value="5" min="1" max="20">
      </div>

      <button id="startBtn">Start Avatar Creation</button>
      <span id="status" class="status idle">Idle</span>
    </div>

    <div class="workspace">
      <div class="panel">
        <h2>Canvas</h2>
        <canvas id="canvas" width="512" height="512"></canvas>
        <div class="iteration-info">
          Iteration: <span id="currentIteration">0</span> / <span id="totalIterations">0</span>
        </div>
        <div class="film-reel">
          <div class="film-reel-title">üìΩÔ∏è Progression:</div>
          <div id="filmReel"></div>
        </div>
      </div>

      <div class="panel">
        <h2>Generated Code</h2>
        <div class="code-display">
          <pre id="codeDisplay">No code generated yet...</pre>
        </div>

        <h2 style="margin-top: 20px;">Thinking Process</h2>
        <div class="thinking-display">
          <pre id="thinkingDisplay">No thinking yet...</pre>
        </div>

        <h2 style="margin-top: 20px;">Log</h2>
        <div class="log" id="log"></div>
      </div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const startBtn = document.getElementById('startBtn');
    const statusEl = document.getElementById('status');
    const personaInput = document.getElementById('persona');
    const iterationsInput = document.getElementById('iterations');
    const codeDisplay = document.getElementById('codeDisplay');
    const thinkingDisplay = document.getElementById('thinkingDisplay');
    const logEl = document.getElementById('log');
    const currentIterationEl = document.getElementById('currentIteration');
    const totalIterationsEl = document.getElementById('totalIterations');
    const filmReelEl = document.getElementById('filmReel');

    let isRunning = false;
    let lastCode = '';
    let lastThinking = '';
    let filmFrames = []; // Array of {iteration, imageData, code, thinking}

    function log(message, isError = false) {
      const entry = document.createElement('div');
      entry.className = 'log-entry' + (isError ? ' error' : '');
      const timestamp = new Date().toLocaleTimeString();
      entry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
      logEl.insertBefore(entry, logEl.firstChild);
    }

    function setStatus(status) {
      statusEl.className = 'status ' + status;
      statusEl.textContent = status.charAt(0).toUpperCase() + status.slice(1);
    }

    function clearCanvas() {
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function executeCode(code) {
      try {
        clearCanvas();
        // Create a function to isolate the code execution
        const fn = new Function('ctx', 'canvas', code);
        fn(ctx, canvas);
        return { success: true };
      } catch (error) {
        return { success: false, error: error.message };
      }
    }

    function getCanvasImage() {
      return canvas.toDataURL('image/png').split(',')[1]; // Get base64 without prefix
    }

    function getCanvasImageDataURL() {
      return canvas.toDataURL('image/png'); // Full data URL with prefix
    }

    function addFilmFrame(iteration, imageDataURL, code, thinking) {
      filmFrames.push({ iteration, imageDataURL, code, thinking });
      
      const frame = document.createElement('div');
      frame.className = 'film-frame';
      frame.dataset.iteration = iteration;
      
      const img = document.createElement('img');
      img.src = imageDataURL;
      
      const label = document.createElement('div');
      label.className = 'film-frame-label';
      label.textContent = `#${iteration + 1}`;
      
      frame.appendChild(img);
      frame.appendChild(label);
      
      frame.addEventListener('click', () => {
        loadFilmFrame(iteration);
      });
      
      filmReelEl.appendChild(frame);
      
      // Mark this frame as active
      updateActiveFrame(iteration);
    }

    function updateActiveFrame(iteration) {
      filmReelEl.querySelectorAll('.film-frame').forEach(frame => {
        frame.classList.toggle('active', parseInt(frame.dataset.iteration) === iteration);
      });
    }

    function loadFilmFrame(iteration) {
      const frame = filmFrames[iteration];
      if (frame) {
        // Load the image back onto the canvas
        const img = new Image();
        img.onload = () => {
          clearCanvas();
          ctx.drawImage(img, 0, 0);
        };
        img.src = frame.imageDataURL;
        
        // Update code display
        codeDisplay.textContent = frame.code;
        
        // Update thinking display
        thinkingDisplay.textContent = frame.thinking || 'No thinking recorded for this iteration';
        
        // Update active frame
        updateActiveFrame(iteration);
        
        log(`Viewing iteration ${iteration + 1}`);
      }
    }

    function clearFilmReel() {
      filmFrames = [];
      filmReelEl.innerHTML = '';
    }

    async function runIteration(iterationNumber, totalIterations) {
      try {
        log(`Starting iteration ${iterationNumber + 1}/${totalIterations}...`);
        currentIterationEl.textContent = iterationNumber + 1;

        const previousImage = iterationNumber > 0 ? getCanvasImage() : undefined;
        const previousCode = iterationNumber > 0 ? lastCode : undefined;

        const response = await fetch('/api/iterate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            persona: personaInput.value,
            iterationNumber,
            totalIterations,
            previousImage,
            previousCode,
          }),
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'API call failed');
        }

        // Clean up the code (remove markdown if present)
        let code = data.code;
        code = code.replace(/```javascript\n?/g, '').replace(/```\n?/g, '').trim();

        const thinking = data.thinking || '';

        codeDisplay.textContent = code;
        thinkingDisplay.textContent = thinking || 'No thinking for this iteration';

        // Execute the code
        const result = executeCode(code);
        
        if (result.success) {
          log(`‚úì Iteration ${iterationNumber + 1} complete - avatar updated`);
          
          // Save the code and thinking for the next iteration
          lastCode = code;
          lastThinking = thinking;
          
          // Add to film reel
          const imageDataURL = getCanvasImageDataURL();
          addFilmFrame(iterationNumber, imageDataURL, code, thinking);
        } else {
          log(`‚úó Error executing code: ${result.error}`, true);
          throw new Error(result.error);
        }

        return true;
      } catch (error) {
        log(`‚úó Error in iteration ${iterationNumber + 1}: ${error.message}`, true);
        return false;
      }
    }

    async function startAvatarCreation() {
      if (isRunning) return;

      isRunning = true;
      startBtn.disabled = true;
      setStatus('running');
      lastCode = '';
      lastThinking = '';
      clearFilmReel();

      const totalIterations = parseInt(iterationsInput.value);
      totalIterationsEl.textContent = totalIterations;
      currentIterationEl.textContent = '0';

      log(`üé® Starting avatar creation with ${totalIterations} iterations...`);
      clearCanvas();

      for (let i = 0; i < totalIterations; i++) {
        const success = await runIteration(i, totalIterations);
        if (!success) {
          log('Stopping due to error', true);
          break;
        }
        
        // Small delay between iterations to see the progression
        if (i < totalIterations - 1) {
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
      }

      log(`‚úì Avatar creation complete!`);
      isRunning = false;
      startBtn.disabled = false;
      setStatus('idle');
    }

    startBtn.addEventListener('click', startAvatarCreation);

    // Initialize
    clearCanvas();
    log('Ready to begin. Configure settings and click "Start Avatar Creation".');
  </script>
</body>
</html>
